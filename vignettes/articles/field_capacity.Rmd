---
title: "Water data"
subtitle: "pcvr v1.1.1.1"
author: Josh Sumner
output: html_document
editor: source
---

```{r}
setwd("~/pcvr")
library(ggplot2)
library(patchwork)
library(devtools)
load_all() # CHANGE FOR RELEASE
```


## Outline

- why you'd work with water data
- overview of WUE vs pWUE
- information from the ditech presentation (vpd, etc)
- reading in water data
- water diagnostic plots
  - annotating water diagnostic plots
- Pwue
  - rate
  - abs
  - normalized_daily_transpiration
- plug for hierarchical models

## Why water data?

- Water is fundamental to plant life.
- Plants need water to survive.
- Water is a critical farming resource.
- Climate change affects water supply.

## How does a plant use water?

The "Pull Theory" says that water moves through a plant based on pressure differentials.

- 1: Water enters the plant through roots (note many root traits will affect how this happens).
- 2: Water travels through the xylem (channels along plant tissue).
- 3: Water is prepared for stomatal exit (stomata are small pores mostly along the underside of leaves).
- 4: Water *Transpires* to the leaf surface (similar to us sweating).
-- Water that has transpired to the surface will then evaporate, but the rate of evaporation depends on *Boundary Layer Conductance*.
--- Boundary Layer Conductance (BLC) is a measure of how easily gas exchange happens in a small "boundary layer" around the plant.
--- BLC is changed by qualities such as leaf shape and angle (think about facing the sun or standing at an angle) as well as phenotypes we don't generally measure with image data such as trichome (small hairs on leaf surface) length and density (think trapping humidity in your hair).
--- Evaporation is also dependent on environmental conditions such as ambient temperature, wind speed, atmospheric pressure, light intensity, soil type, soil moisture content, etc.
--- *Vapor Pressure Deficit* (VPD) is another important quantity for evaporation and transpiration. VPD is the difference in the amount of water in the air vs the amount of water the air can hold at the given temperature. Since warmer air can hold more water VPD is higher on a hot day even when relative humidity is held constant, this is an important consideration for experimental design particularly in growth chambers.

Transpiration has to be balanced carefully by a plant since the plant is using water both to build new biomass and to cool off.

There can be secondary consequences to increased transpiration depending on the experimental design and what you are measuring, for instance:
- Higher transpiration means higher Transport of nutrients into the plant from soil.
- Higher transpiration means faster transport of metabolites in the plant.
- Higher transpiration reduces leaf temperature.
- Higher transpiration allows for easier pathogen infection via open stomata.
- Water pH and salt content affect uptake and the plant cells.

## Measuring water use

Measuring water use can be difficult. Broadly we can either measure water vapor released from the plant or measure the amount of water removed from the soil. Measuring gasses tends to be more difficult, so we tend to focus on weight changes to the pot.

Measuring water use via weight changes in a planted pot has some caveats. First, we have to assume that there is a period of neglibible transpiration (we tend to assume that when lights are off and stomata are closed at night no water is transpired). Second, we have to assume that the only way that water is lost from the pot is via transpiration through the plant.

In the following plot we look at a simulated plant's watering data. This plant has been weighed for 5 days, with water added in the middle of the night and plants weighed shortly before watering and when lights come on in the morning. The differences between adjacent waterings are what we will use later on to calculate transpiration and *water use efficiency* (WUE).

```{r, eval = TRUE, echo = FALSE}
set.seed(123)
days <- 5
n_plants <- 1
ex <- data.frame(id = paste0("Plant ", rep(seq_len(n_plants), each = days * 2)),
           DAS = rep(c(1:days - 0.5, 1:days + 0.1), times = n_plants),
           variable = rep(c("weight_after_watering", "weight_before_watering"), each = days),
           value = unlist(lapply(seq_len(n_plants), function(i) {
             x <- sort(runif(days, 50, 100))
             c(x, x - runif(days, 10, 20))
           })))
daybars <- data.frame(ymin = 0, ymax = 1.1 * max(ex$value),
           xmin = seq(0, days, 0.5),
           xmax = seq(0.5, days + 0.5, 0.5),
           day_or_night = rep(c("lights off", "lights on"), length.out = 11))

watering_1 <- data.frame(id = ex[1, "id"],
                   water = ex[2, "value"],
                   start = mean(c(ex[2, "value"], ex[c(days + 1), "value"])),
                   DAS = ex[c(days + 1), "DAS"] + 0.75)

watering_2 <- data.frame(id = ex[1, "id"],
                   water = ex[3, "value"],
                   start = mean(c(ex[3, "value"], ex[c(days + 2), "value"])),
                   DAS = ex[c(days + 2), "DAS"] + 0.175)

ggplot(ex, aes(x = DAS, y = value, color = variable)) +
  facet_wrap(~id) +
  geom_rect(data = daybars, aes(xmin = xmin, ymin = ymin, xmax = xmax, ymax = ymax,
                                fill = day_or_night),
            inherit.aes = FALSE, alpha = 0.5) +
  scale_fill_manual(values = c("gray80", "antiquewhite")) +
  scale_x_continuous(breaks = seq(1, 6, 1)) +
  coord_cartesian(ylim = c(0.9 * round(min(ex$value)), 1.1 * round(max(ex$value))),
                  expand = FALSE) +
  geom_line(color = "black") +
  geom_point() +
  geom_segment(data = watering_1, aes(x = DAS, xend = DAS, y = start, yend = water),
               linetype = 5, color = "gray40", inherit.aes = FALSE) +
  geom_label(data = watering_1, aes(x = DAS, y = water), hjust = 0.75, vjust = -0.25,
             label = "Water lost\nduring day", inherit.aes = FALSE)+
  geom_segment(data = watering_2, aes(x = DAS, xend = DAS, y = start, yend = water),
               linetype = 5, color = "gray40", inherit.aes = FALSE) +
  geom_label(data = watering_2, aes(x = DAS, y = water), hjust = 0.5, vjust = -0.25,
             label = "Water added\nat night", inherit.aes = FALSE) +
  annotate("segment", x = seq(1.25, days, 1), xend = seq(1.25, days, 1),
           y = round(min(ex$value))- 4,
           yend = round(min(ex$value)), linetype = 3,  color = "navy") +
  annotate("label", x = days - 1, y = round(min(ex$value)), label = "watering times",
           vjust = -0.25, hjust = -0.25) +
  labs(x = "Days After Start", y = "Pot Weight (g)",
       fill = "Light", color = "Weight") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

## Calculating Transpiration

```{r, eval = TRUE, echo = FALSE}
exw <- ex
exw$DAS <- rep(seq(1, days, 1), times = 2) - 0.2
exw <- reshape2::dcast(exw, DAS + id ~ variable, value.var = "value")
exw$diff <- exw$weight_after_watering - exw$weight_before_watering

ggplot(ex, aes(x = DAS, y = value, color = variable)) +
  facet_wrap(~id) +
  geom_rect(data = daybars, aes(xmin = xmin, ymin = ymin, xmax = xmax, ymax = ymax,
                                fill = day_or_night),
            inherit.aes = FALSE, alpha = 0.5) +
  scale_fill_manual(values = c("gray80", "antiquewhite")) +
  scale_x_continuous(breaks = seq(1, 6, 1)) +
  coord_cartesian(ylim = c(0.9 * round(min(ex$value)), 1.1 * round(max(ex$value))),
                  expand = FALSE) +
  geom_line(color = "black") +
  geom_point() +
  geom_text(data = exw, aes(x = DAS, y = weight_after_watering, label = round(diff, 1)), 
            inherit.aes = FALSE) +
  labs(x = "Days After Start", y = "Pot Weight (g)",
       fill = "Light", color = "Weight", title = "Amount of water transpired per day") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

Transpiration doesn't generally give us enough information to use until it is normalized to biomass. We generally expect larger plants to transpire more since they have more area to draw water through and typically have more extensive root structures. Instead of using daily transpiration we often want to talk about *Normalized Transpiration* or *Water Use Efficiency*.

**Note:** the values above are positive because we are framing the question as "the amount of water transpired", so despite the slope of the line (showing mass in the pot) going down we have positive numbers.

To normalize transpiration we need a measure or a proxy of plant biomass.

```{r, eval = TRUE, echo = FALSE}
set.seed(345)
exw$biomass <- sort(runif(days, 5, 15))

p1 <- ggplot(exw, aes(x = DAS, y = biomass)) +
  facet_wrap(~id) +
  geom_line(color = "black") +
  geom_point() +
  labs(x = "Days After Start", y = "Plant Biomass (g)",
       fill = "Light", color = "Weight", title = "Plant Biomass (g)") +
  pcv_theme() +
  theme(legend.position = "bottom")

p2 <- ggplot(ex, aes(x = DAS, y = value, color = variable)) +
  facet_wrap(~id) +
  geom_rect(data = daybars, aes(xmin = xmin, ymin = ymin, xmax = xmax, ymax = ymax,
                                fill = day_or_night),
            inherit.aes = FALSE, alpha = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = c("gray80", "antiquewhite")) +
  scale_x_continuous(breaks = seq(1, 6, 1)) +
  coord_cartesian(ylim = c(0.9 * round(min(ex$value)), 1.1 * round(max(ex$value))),
                  expand = FALSE) +
  geom_line(color = "black") +
  geom_point() +
  geom_text(data = exw, aes(x = DAS + 0.1, y = weight_after_watering,
                            label = paste0(round(diff, 1), "/", round(biomass, 1))), 
            inherit.aes = FALSE, size = 3) +
  labs(x = "Days After Start", y = "Pot Weight (g)",
       fill = "Light", color = "Weight", title = "Normalized Transpiration (water/biomass)") +
  pcv_theme() +
  theme(legend.position = "bottom")

p2 + p1 + patchwork::plot_layout(widths = c(2, 1))
```

## WUE

Another important water metric is water use efficiency. Water use efficiency is generally calculated as a rate of biomass gained per unit of water.

$\frac{\Delta(\text{Biomass})_t}{\text{Water Transpired}_t}$

WUE might also be considered as the amount of water used to sustain a given biomass, which here is referred to as "absolute WUE".

$\frac{\text{Biomass}_t}{\text{Water Transpired}_t}$

### PWUE

Both WUE methods require a measure of biomass. Generally in high-throughput plant phenotyping we use a proxy for biomass, such as area (number of pixels labelled as a plant). Because we are using a proxy for biomass we have to call image-based WUE *Pseudo-Water Use Efficiency* (pWUE).

In `pcvr` the `pwue` function calculates normalized transpiration, rate based pWUE, and absolute pWUE.

## Reading in water data

In this article we'll use simulated data, but the `bw.water` function may be helpful for you reading in JSON Lemnatech metadata.

Here for more control we'll use simulated data:

#### Simulated Data

We'll simulate groups of data with distinct watering and growth trends that we will go over next.

```{r}
set.seed(123)
days <- 25
n_plants <- 10
phenotype_conditions <- list(
  "death" = list("model" = "monomolecular", params = list(A = 50, B = 0.03)),
  "sigmoid" = list("model" = "logistic", params = list(A = 200, B = 12, C = 3.5)),
  "abrupt" = list("model" = "logistic", params = list(A = 200, B = 12, C = 1)),
  "exponential" = list("model" = "exponential", params = list(A = 1, B = 0.2)),
  "slowing" = list("model" = "power law", params = list(A = 15, B = 0.6)),
  "linear" = list("model" = "linear", params = list(A = 8))
)
# 10 + (sub$area * rbeta(days, 200, 200))
watering_conditions <- list(
  "constant" = list("before" = NA,
                    "after" = rep(25, days)),
  "target weight" = list("before" = round(90 * exp(-0.1 * seq_len(days))),
                         "after" = rep(100, days)),
  "increasing cont" = list("before" = NA,
                           "after" = (seq_len(days) * 4) + 10),
  "decreasing cont" = list("before" = NA,
                           "after" = (days * 4) + 10 - (4 * seq_len(days))),
  "increasing step" = list("before" = NA,
                           "after" = c(rep(20, floor(days/2)), rep(75, ceiling(days/2)))),
  "decreasing step" = list("before" = NA,
                           "after" = c(rep(75, floor(days/2)), rep(20, ceiling(days/2))))
)

ex <- do.call(rbind, lapply(names(phenotype_conditions), function(pc) {
  p_cond <- phenotype_conditions[[pc]]
  df <- pcvr::growthSim(p_cond$model, n = n_plants, t = days,
                        params = p_cond$params)
  df$group <- pc
  colnames(df)[c(2, 4)] <- c("pc", "area")
  #* for this phenotype data make a copy for each watering condition set
  do.call(rbind, lapply(names(watering_conditions), function(wc) {
    w_cond <- watering_conditions[[wc]]
    #* per each individual make weight_before and weight_after columns
    wcdf <- do.call(rbind, lapply(unique(df$id), function(i) {
      # subset data
      sub <- df[df$id == i, ]
      # define vectors for each
      b <- sort(w_cond$before + rpois(days, 1), decreasing = TRUE)
      w <- w_cond$after
      if (all(is.na(w_cond$before))) {
        b <- 10 + (sub$area * rbeta(days, 200, 200))
        w <- b + w_cond$after
      }
      # add columns
      sub$weight_before <- b
      sub$weight_after <- w
      return(sub)
    }))
    wcdf$wc <- wc
    return(wcdf)
  }))
}))

key <- expand.grid(pc = names(phenotype_conditions), wc =  names(watering_conditions))
key$group <- as.character(seq_len(nrow(key)))
ex <- plyr::join(ex, key)
ex$pc <- factor(ex$pc, levels = c("sigmoid", "abrupt", "exponential",
                                  "slowing", "linear", "death"),
                ordered = TRUE)
ex$wc <- factor(ex$wc, levels = c("constant", "target weight",
                                  "increasing cont","decreasing cont",
                                  "increasing step", "decreasing step"),
                ordered = TRUE)
```

#### Traits of the simulated data

The simulated data has 6 phenotype trends. Here we're using simulated area from a hypothetical 2D image.

- `sigmoid`: This is pretty typical logistic growth.
- `abrupt`: Logistic growth with a very abrupt growth period.
- `exponential`: Exponential growth, non-asymptotic and speeding up.
- `slowing`: Non-asymptotic growth, slower than linear.
- `linear`: Non-asymptotic linear growth.
- `death`: Slow asymptotic growth with a very low asymptote.

```{r}
ggplot(ex[ex$wc == "constant", ], aes(time, area, group = id)) +
  facet_wrap(~pc) +
  geom_line() +
  labs(y = expression("Area (cm"^2*")"),
       x = "Time",
       title = "Treatments with several different growth trends") +
  pcv_theme() +
  theme(legend.position = "none")
```

There are also 6 watering data options in the simulated data.

- `constant`: Pre-watering weight increases with the phenotype (area), and a constant amount of water is added to that pre-watered weight.
- `target weight`: **Here we assume that the weight of the plant is negligible** (as we generally assume on Lemnatech style high-throughput phenotyping experiments). Every day the plant uses some amount of water and as the plant grows that amount increases, driving the pre-watering weight down over time. At each watering the pot is filled until it hits a target weight (100g here, just to use a nice round number).
- `increasing cont.`: Pre-watering weight increases with the phenotype (area), and every day a larger amount of water is added to that pre-watered weight.
- `decreasing cont.`: Pre-watering weight increases with the phenotype (area), and every day a smaller amount of water is added to that pre-watered weight.
- `increasing step`: Pre-watering weight increases with the phenotype (area), and a constant amount of water is added to that pre-watered weight every day, but half way through the experiment that amount of water increases from 20g to 75g.
- `decreasing step`: Pre-watering weight increases with the phenotype (area), and a constant amount of water is added to that pre-watered weight every day, but half way through the experiment that amount of water decreases from 75g to 20g.

```{r}
l <- reshape2::melt(ex[ex$pc == "sigmoid", ], id.vars = c("id", "group", "time", "wc"),
                    measure.vars = c("weight_before", "weight_after"))

ggplot(l[l$id %in% paste0("id_", 1), ],
       aes(x = time + ifelse(variable == "weight_before", -0.25, 0.25), y = value, color = variable)) +
  facet_wrap(~wc) +
  geom_line(color = "black") +
  geom_point() +
  labs(y = "Weight", x = "Time",
       title = "Different watering schemes with sigmoid growth") +
  pcv_theme()
```

Combining everything from those sets of conditions we can look at the pre vs post watering weights for all 36 of our options. Phenotypes shown in light gray, pot weight after watering shown in blue.

```{r}
ggplot(ex, aes(time, area, group = id)) +
  facet_grid(wc~pc) +
  geom_line(color = "gray70", linewidth = 0.1) +
  geom_line(aes(y = weight_after), color = "blue") +
  labs(y = "Weight After Watering",
       x = "Time",
       title = "Weight After Watering For all combinations of conditions") +
  pcv_theme() +
  theme(legend.position = "none",
        strip.text.x.top = element_text(size = 10),
        strip.text.y.right = element_text(size = 10))
```

We can also look at this as the amount of water added for each condition. That will make everything constant across phenotypes (except target weight, which is the only option that is not a perfectly straight/stepped line).

```{r}
ggplot(ex[ex$id == "id_1", ],
       aes(time, y = weight_after - weight_before, group = id)) +
  facet_grid(wc~pc) +
  geom_line() +
  labs(y = "Water Added",
       x = "Time",
       title = "Water added for all combinations of conditions") +
  pcv_theme() +
  theme(legend.position = "none",
        strip.text.x.top = element_text(size = 10),
        strip.text.y.right = element_text(size = 10))
```

### Water data diagnostic plots

Before working with water derived metrics it's generally good to get a feeling for the raw watering data with similar plots as we used early on. Here we're checking that there are reasonable looking differences between subsequent weights, that any treatment groups have the expected watering pattern, and that the weight before watering is lower than the previous post-watering weight (indicating that transpiration happened). The length of the black lines between weights here shows the same information as the previous "water added" plot.

```{r, echo = FALSE}
ggplot(l[l$id %in% paste0("id_", 1:3), ],
       aes(x = time + ifelse(variable == "weight_before", -0.25, 0.25),
           y = value, color = variable)) +
  facet_grid(id~wc) +
  geom_line(color = "black", linewidth = 0.1) +
  geom_point(size = 0.5) +
  labs(y = "Weight", x = "Time",
       title = "Treatments with several different watering schemes") +
  pcv_theme() +
  theme(legend.position = "none",
        strip.text.x.top = element_text(size = 10),
        strip.text.y.right = element_text(size = 10))
```

We don't see anything that raises red flags, so we'll move on.

## `pwue`

The `pwue` function takes one or two dataframes as input. If one dataframe is given then it should include phenotypes and watering amounts and is expected in wide format. If two dataframes are given then one should contain phenotypes and the other should contain watering data.
The `pheno`, `time`, and `id` arguments control which variables are used to normalize for plant size (`pheno`), subset the data to a given time (`time`) and to identify a plant over time (`id`).
The `offset` argument optionally controls how long before a phenotype's measurement water has to have been added to count towards that phenotype, normally this is left 0.
`pre_watering` and `post_watering` should name columns of the dataframe containing water information corresponding to pre-watering weight and post-watering weight.
Finally, the `method` argument controls which values are calculated. Currently it accepts "rate", "abs", and "ndt" for the rate based pWUE, absolute value pWUE, and Normalized Daily Transpiration.

Note that here we are using very coarse measurements of time and for some experiments more granular time data is essential.

### Rate Based

```{r}
rb <- pwue(df = ex, w = NULL, pheno = "area", time = "time", id = c("id", "group"),
           pre_watering = "weight_before",
           post_watering = "weight_after", method = "rate")
```

We'll look at an example rep of each group to get started. Using the grid faceting we can't free the scales, so we'll go over each watering condition in turn.

#### Constant Watering

- `constant`: Pre-watering weight increases with the phenotype (area), and a constant amount of water is added to that pre-watered weight.

Remember that the rate-based pWUE formula we are using is $\frac{\Delta(\text{Biomass})_t}{\text{Water Transpired}_t}$. In this watering condition the denominator is a constant. Since the numerator is the measurement-to-measurement change it is essentially the derivative (slope) of the original phenotype.

With that in mind we can start thinking about what we'd expect to see. As an example, the `death` group is always going to have small values for pWUE compared to other groups since the change in size between any two measurements is always very small. If we zoom in then there should be a downward trend driven by the phenotype increasing by smaller and smaller amounts towards an asymptotic limit. `death` shows slow monomolecular growth with a low asymptote when compared to our other groups. Similarly, the `sigmoid` group should start to look like a bell curve, since the derivative of a sigmoid is bell shaped (the CDF of a normal distribution is a logistic curve, etc).

```{r}
rbc <- rb[rb$wc == "constant", ]
ggplot(rbc, aes(x = time, y = pWUE, group = id)) +
  facet_wrap(~pc, scales = "free_y") +
  geom_line() +
  labs(title = "Zooming in on the constant watering condition") +
  pcv_theme()
```

This follow the general trends we'd expect, but some things look strange and it all looks very noisy.

##### Sigmoid

As mentioned above, we expect a roughly bell shaped plot of rate pWUE over time for our data with constant watering and logistic growth.

```{r}
ggplot(rbc[rbc$pc == "sigmoid", ], 
       aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Constant Watering with Logistic Growth",
       y = "(Rate based) pWUE") +
  pcv_theme()
```

The overall trend makes sense, but why is the data so spikey? We can sometimes get an easier grasp of pWUE if we plot the component parts, which are both returned from `pwue`.

```{r}
ggplot(rbc[rbc$pc == "sigmoid", ],
       aes(x = time, group = id)) +
  facet_wrap(~group) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "constant watering, logistic growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

Now we can see that the "spikey-ness" is a product of the water data having a lot of noise, which is likely to be the case in real data but for our simulation is just a byproduct of how we're making the pre-watering weights.

##### Abrupt

The typical sigmoid data was pretty simple, but what happens if we have a different kind of sigmoid shape? First looks at the pWUE for our "abrupt" logistic growth are way less friendly.

```{r}
ggplot(rbc[rbc$pc == "abrupt", ], 
       aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Constant Watering with Abrupt Growth",
       y = "(Rate based) pWUE") +
  pcv_theme()
```

We're going to have to zoom in to understand the general trend, then we can look at each replicate to see what is going on with that large spike.

```{r}
ggplot(rbc[rbc$pc == "abrupt", ], 
       aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Constant Watering with Abrupt Growth",
       y = "(Rate based) pWUE") +
  pcv_theme() +
  coord_cartesian(ylim = c(-3, 50))
```

That doesn't clear it up much, but we do basically have the same kind of shape as before where the logistic phenotype yielded a bell curve.

The first big problem we see is that pWUE is negative in some cases. Normally we'd say that if we add a constant amount of water to each "before" weight that the "after" weight has to be larger, so the difference must be positive. That is true, but with this phenotype we have fast enough changes measurement-to-measurement between days 10 to 14 that we see a couple of times where the previous `weight_after_watering` is lower than the current `weight_before_watering`. In our case this is a product of the simulation having very simple rules but this sort of discrepancy comes up a lot with water data since there are so many possible sources of error and noise. Generally we will remove any negative values for `total_water`. pWUE can also be flipped to be negative if the numerator (change in biomass) becomes negative. In most experiments that is indicative of a shortcoming of images as a proxy for biomass or an image analysis problem. It's a good idea to figure out why you have negative values since it might indicate an interesting stress response, a problem with equipment or a problem with upstream analysis. In reality this sort of thing shows up all the time due to all sorts noise, measurement error, and image analysis problems.

```{r}
rbcp <- rbc[rbc$pc == "abrupt", ]
summary(rbcp$total_water)
rbcp <- rbcp[which(rbcp$total_water > 0), ]
```

Now that we've removed the negative values we can think about the components of rate pWUE a little more clearly.

```{r}
ggplot(rbcp,
       aes(x = time, group = id)) +
  facet_wrap(~id) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "constant watering, abrupt growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

Notice that we have dips in the amount of water used that coincide with the peaks of measurement-to-measurement phenotype change. That's a combination that will make for some very high pWUE peaks and plenty of noise.
The peaks in measurement-to-measurement phenotype change have to happen with such fast changes.
The troughs in amount of water used may be seen on a system where the weight of a pot changes noticeably with the measured phenotype (the plant is a non-neglible amount of the total weight of whatever pot/cart is being weighed), but that will depend on your equipment. This trend is very dramatic, it is likely that in your experiments the soil and pot would out weight the plant by several orders of magnitude which would make for less steep pWUE curves.

```{r}
ggplot(rbcp,
       aes(x = time, y = pWUE, group = id)) +
  facet_wrap(~id, scales = "free_y") +
  geom_line() +
  labs(title = "Constant Watering with Abrupt Growth",
       y = "(Rate based) pWUE") +
  pcv_theme()
```

##### Exponential

The previous two phenotype options were asymptotic. What happens with non-asymptotic growth?

```{r}
ggplot(rbc[rbc$pc == "exponential", ], 
       aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Constant Watering with Exponential Growth",
       y = "(Rate based) pWUE") +
  pcv_theme()
```

As before we'll remove the negative values for `total_water`. Here they come from the same place since the phenotype is changing so quickly.

```{r}
rbce <- rbc[which(rbc$pc == "exponential" & rbc$total_water > 0), ]

ggplot(rbce,
       aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Constant Watering with Exponential Growth",
       y = "(Rate based) pWUE") +
  pcv_theme()
```

With the negative values removed the trend here looks a lot like the raw phenotype data.

```{r}
ggplot(ex[ex$pc == "exponential" & ex$wc == "constant", ],
       aes(time, area, group = id)) +
  facet_grid(wc~pc) +
  geom_line() +
  labs(y = "Area",
       x = "Time",
       title = "Exponential Phenotype") +
  pcv_theme() +
  theme(legend.position = "none",
        strip.text.x.top = element_text(size = 10),
        strip.text.y.right = element_text(size = 10))
```

This is a feature of exponential growth, since the measurement-to-measurement difference increases exponentially when we have roughly constant water use the pWUE trend will look exponential.

```{r}
ggplot(rbce,
       aes(x = time, group = id)) +
  facet_wrap(~id) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "constant watering, abrupt growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

##### Slowing

For non-asymptotic growth that is slowing down (exponent below 1) we should expect to see decreasing pWUE given constant watering.

```{r}
ggplot(rbc[rbc$pc == "slowing", ], 
       aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Constant Watering with Power law (B<1) Growth",
       y = "(Rate based) pWUE") +
  pcv_theme()
```

While the growth is non-asymptotic pWUE is asymptotic since the numerator is monotone increasing but is slowing down while the denominator is roughly constant.

##### Linear

The measurement-to-measurement change in linear data is the same between any two subsequent times. Since the water data is roughly constant (at least it has a 0 slope) we expect to see flat but noisy pWUE here.

```{r}
ggplot(rbc[rbc$pc == "linear", ], 
       aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Constant Watering with Linear Growth",
       y = "(Rate based) pWUE") +
  pcv_theme()
```


##### Death

Now we can look at the `death` group, which taken separately looks like a totally normal growth curve.

```{r}
ggplot(rbc[rbc$pc == "death", ],
       aes(time, area, group = interaction(group, id))) +
  facet_wrap(~group) +
  geom_line(aes(color = group)) +
  geom_point(aes(color = group), size = 0.7) +
  labs(y = expression("Area (cm"^2*")"),
       x = "Time",
       title = "Zooming in on the phenotype data for death") +
  pcv_theme() +
  theme(legend.position = "none")
```

The measurement-to-measurement change for any asymptotic phenotype approaches 0 at the same rate as the phenotype approaches the asymptote. This measurement-to-measurement change is returned from `pwue` as the `pheno_diff` column, plotted below.

```{r}
pheno_diff_ag <- aggregate(cbind(area, pheno_diff) ~ time + group,
                           rbc[rbc$time %% 2 == 0 & rbc$pc == "death", ],
                           mean, na.rm = TRUE)

ggplot(rbc[rbc$pc == "death", ],
       aes(time, area)) +
  facet_wrap(~group) +
  geom_line(aes(color = group, group = interaction(group, id))) +
  geom_point(aes(color = group), size = 0.7) +
  geom_label(data = pheno_diff_ag,
            aes(label = round(pheno_diff, 1))) +
  labs(y = expression("Area (cm"^2*")"),
       x = "Time",
       title = "Labeling the average pheno_diff ever other day") +
  pcv_theme() +
  theme(legend.position = "none")
```

```{r}
names(watering_conditions)
```

#### Target Weight

- `target weight`: **Here we assume that the weight of the plant is negligible** (as we generally assume on Lemnatech style high-throughput phenotyping experiments). Every day the plant uses some amount of water and as the plant grows that amount increases, driving the pre-watering weight down over time. At each watering the pot is filled until it hits a target weight (100g here, just to use a nice round number).

```{r}
rbt <- rb[rb$wc == "target weight", ]
ggplot(rbt, aes(x = time, y = pWUE, group = id)) +
  facet_wrap(~pc, scales = "free_y") +
  geom_line() +
  labs(title = "Zooming in on the constant watering condition") +
  pcv_theme()
```

Luckily, compared to the constant watering we can see that there aren't any crazy peaks or negative values here.

##### Sigmoid

If we were only looking at the numerator we would expect a bell curve. Since the denominator now increases over time (more water being added to reach the target weight since the plant transpires more each day as it grows larger), we should see bell curves that starts high, have a center "lump", then end low.

```{r}
rbts <- rbt[rbt$pc == "sigmoid", ]
ggplot(rbts, aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Sigmoid growth and target weight watering") +
  pcv_theme()
```

Broken into the component pieces the rationale behind the trend we see is obvious:

```{r}
ggplot(rbts,
       aes(x = time, group = id)) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "Target Weight watering, logistic growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

##### Abrupt

Now we can look at "sharper" logistic growth.

```{r}
rbta <- rbt[rbt$pc == "abrupt", ]
ggplot(rbta, aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Abrupt growth and target weight watering") +
  pcv_theme()
```

Why doesn't this plot show the same trend as the sigmoid phenotype did? The denominator should be the same between these two groups.

```{r}
ggplot(rbta,
       aes(x = time, group = id)) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "Target Weight watering, abrupt growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

Again, breaking pWUE into the numerator and denominator helps understand the trend. In this data we see that since the phenotype jumps so quickly through the entire growth period with essentially 0 measurement-to-measurement change in the beginning (before it really starts growth) and the end (when it's at asymptotic size) we have very small numerators at either end of our experiment, thus the trend we see for pWUE is roughly symmetric.

##### Exponential

Here our numerator increases exponentially while our denominator increases asymptotically. The result we should expect is exponential growth.

```{r}
rbte <- rbt[rbt$pc == "exponential", ]
ggplot(rbte, aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Exponential growth and target weight watering") +
  pcv_theme()
```

And that's what we get. The increase in measurement-to-measurement phenotype outpaces the increase in transpiration.

```{r}
ggplot(rbte,
       aes(x = time, group = id)) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "Target Weight watering, exponential growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

##### Slowing

The derivative of our non-asymptotic but slowing in growth rate phenotype is asymptotic at 0. With our numerator decreasing and the denominator increasing we should see pWUE start high and approach 0 very quickly.

```{r}
rbtsl <- rbt[rbt$pc == "slowing", ]
ggplot(rbtsl, aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Slowing growth and target weight watering") +
  pcv_theme()
```

And that's what we get. We can check our intuition again by looking at the component pieces.

```{r}
ggplot(rbtsl,
       aes(x = time, group = id)) +
  facet_wrap(~group) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "Target Weight watering, slowing growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

##### Linear

Here our numerator is constant and the denominator (transpiration) is increasing, so we should see pWUE decrease over time, but never getting to 0.

```{r}
rbtl <- rbt[rbt$pc == "linear", ]
ggplot(rbtl, aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Linear growth and target weight watering") +
  pcv_theme()
```

And that's what we get. We can check our intuition again by looking at the component pieces.

```{r}
ggplot(rbtl,
       aes(x = time, group = id)) +
  facet_wrap(~group) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "Target Weight watering, linear growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

##### Death

Here we should see a very similar trend as we saw with non-asymptotic growth that is slowing down. Here our growth is asymptotic but the effect on the numerator should be the same.

```{r}
rbtd <- rbt[rbt$pc == "death", ]
ggplot(rbtd, aes(x = time, y = pWUE, group = id)) +
  geom_line() +
  labs(title = "Linear growth and target weight watering") +
  pcv_theme()
```

It does look very similar to the slowing growth. We can check our intuition again by looking at the component pieces.

```{r}
ggplot(rbtd,
       aes(x = time, group = id)) +
  facet_wrap(~group) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = pheno_diff, color = "Phenotype (numerator)")) +
  labs(title = "Components of Rate pWUE",
       subtitle = "Target Weight watering, poor growth",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

#### Increasing Continuous
- `increasing cont.`: Pre-watering weight increases with the phenotype (area), and every day a larger amount of water is added to that pre-watered weight.


##### Sigmoid

##### Abrupt

##### Exponential

##### Slowing

##### Linear

##### Death

#### Decreasing Continuous
- `decreasing cont.`: Pre-watering weight increases with the phenotype (area), and every day a smaller amount of water is added to that pre-watered weight.


##### Sigmoid

##### Abrupt

##### Exponential

##### Slowing

##### Linear

##### Death

#### Increasing Step
- `increasing step`: Pre-watering weight increases with the phenotype (area), and a constant amount of water is added to that pre-watered weight every day, but half way through the experiment that amount of water increases from 20g to 75g.

##### Sigmoid

##### Abrupt

##### Exponential

##### Slowing

##### Linear

##### Death

#### Decreasing Step
- `decreasing step`: Pre-watering weight increases with the phenotype (area), and a constant amount of water is added to that pre-watered weight every day, but half way through the experiment that amount of water decreases from 75g to 20g.

##### Sigmoid

##### Abrupt

##### Exponential

##### Slowing

##### Linear

##### Death



### Absolute Value Based

##### Sigmoid

##### Abrupt

##### Exponential

##### Slowing

##### Linear

##### Death

Now we'll walk through the data if we consider pWUE through the "absolute" definition. As a reminder, that means we are considering the absolute size of the plant at each timepoint with the formula now being:

$\frac{\text{Biomass}_t}{\text{Water Transpired}_t}$

This type of pWUE is useful for thinking about how much biomass can be maintained per unit of water.

```{r}
a <- pwue(df = ex, w = NULL, pheno = "area", time = "time", id = c("id", "group"),
           pre_watering = "weight_before",
           post_watering = "weight_after", method = "abs")
```

The numerator here is the same as before, so we can check for some problems we already know about.

```{r}
table(a$group, ifelse(a$pWUE < 0, "negative", "positive"))
```

This time we'll plot it with the scales freed on the Y-axis and with values below 0 already removed.

```{r}
apos <- a[which(a$pWUE > 0), ]
ggplot(apos[apos$id %in% paste0("id_", 1:5), ],
       aes(x = time, y = pWUE, group = id)) +
  facet_wrap(~group, scales = "free_y") +
  geom_point(size = 0.5) +
  geom_line() +
  pcv_theme()
```

Here our pWUE data look a lot like the original phenotype data, with the exception of group `F` which we'll get to. That general similarity is because the phenotype data are used as-is in the numerator, and for the most part we don't have drastic changes to the water transpiration (weight changes) over time.

As a summary of what we see, Group `B` starts out the same as Group `A` but at the halfway point when the water amount is lowered the values roughly double (since water was cut in half but the plant stayed the same size). Group `C` looks as expected, the decrease in the amount of water over time is less dramatic than the exponentially increasing phenotype. Groups `D` and `E` should be very similar in terms of their phenotype, but `E` is getting more water each day, which makes its curve end at a lower point despite having the same general shape (check the Y-axis values since the scale is freed).

Group `F` looks strange here though, what is going on there?

```{r}
ggplot(apos[apos$group == "F", ],
       aes(x = time, group = id)) +
  facet_wrap(~id)+
  geom_point(aes(y = total_water, color = "Water (denominator)")) +
  geom_line(aes(y = total_water, color = "Water (denominator)")) +
  geom_point(aes(y = pheno_iter, color = "Phenotype (numerator)")) +
  geom_line(aes(y = pheno_iter, color = "Phenotype (numerator)")) +
  labs(title = "This view kind of helps, but it still doesn't explain our trend clearly",
       y = "Pheno Diff and Water Diff", x = "Time") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

What is happening here is that since our phenotype changes so quickly between measurements 10 and 14 (roughly) the "lag" where we look at the difference in weights becomes very important. Looking at the pre/post watering weights for the first 4 plants in group `F` the problem is more obvious. Between days 10 and 14 the line between those weights is much shorter. In this data the difference is smaller because it's a relatively low effort simulation. In the wild we can see trends like this when an image based phenotype changes more rapidly than the underlying "true quantity". To keep with our area example, if a plant's leaf presentation in 2 dimensions changes in a way that is different than how its biomass actually changes then we can see this. These sort of differences highlight why we say we are using *Pseudo-WUE*. A similar idea could be that when corn is heat-stressed and the leaves furl into a more helical shape when viewed in 2D we don't really think the corn plant lost biomass, it just rearranged itself in a way that an image has fewer plant pixels.

```{r}
ggplot(l[l$group == "F" & l$id %in% paste0("id_", 1:4), ],
       aes(x = time + ifelse(variable == "weight_before", -0.25, 0.25),
           y = value, color = variable, group = id)) +
  facet_wrap(~id) +
  geom_line(color = "black", linewidth = 0.1) +
  geom_point(size = 0.5) +
  labs(y = "Weight", x = "Time",
       title = "Treatments with several different watering schemes") +
  pcv_theme() +
  theme(legend.position = "bottom")
```

So what do we do here?

**I actually have no idea, if you zoom in though the trend is reasonable.**

```{r}
ggplot(apos[apos$group == "F", ],
       aes(x = time, y = pWUE, group = id)) +
  facet_wrap(~group, scales = "free_y") +
  geom_point(size = 0.5) +
  geom_line() +
  coord_cartesian(ylim = c(0, 40)) +
  pcv_theme()
```


### Normalized Daily Transpiration

The last of the phenotypes calculated by `pwue` is normalized daily transpiration (NDT). Normalized transpiration is the reciprocal of the "abs" style pWUE that we just looked at, so it answers a related question. NDT is helpful when we want to investigate how much water is used (transpired) by a given amount of biomass.


```{r}
ndt <- pwue(df = ex, w = NULL, pheno = "area", time = "time", id = c("id", "group"),
           pre_watering = "weight_before",
           post_watering = "weight_after", method = "ndt")
ndt <- ndt[which(ndt$pWUE > 0), ]
```

Again we'll plot our calculated phenotype with the scales freed on the Y-axis and with values below 0 already removed.

```{r}
ggplot(ndt[ndt$id %in% paste0("id_", 1:5), ],
       aes(x = time, y = normalized_daily_transpiration, group = id)) +
  facet_wrap(~group, scales = "free_y") +
  geom_point(size = 0.5) +
  geom_line() +
  pcv_theme()
```

## Field Capacity

### What is field capacity

Field capacity is the amount of water held in soil after excess water has been able to drain and the rate of macropore drainage (water seeping deeper into the ground) approaches 0. Field capacity depends on numerous factors and should not be considered a constant for a given soil type, but it can be useful as a measure of water capacity.


### Why do we care about field capacity

**Why do we care about field capacity**


### Field capacity equations

- **CS**: Weight of carriage + saucer = 345 g
- **DW**: Weight of dry pot (pot + soil) = varies by experiment, will be provided by Leo (one number for the whole experiment)
- **SW**: Weight of saturated pot (pot + soaked soil) = varies by experiment, will be provided by Leo (one number for the whole experiment)
- **Saturated Water Volume**: SW - DW
- **Current water content** = current weight - CS - DW
- **Current field capacity (%)** = current water content / saturated water volume x 100
- **Target field capacity (%)** = provided by Leo, varies by day and experiment

`~~~Guidance on how to use those?~~~`

## Next Steps

















